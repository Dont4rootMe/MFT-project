name: Tests

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]
  workflow_dispatch:  # Allow manual trigger

jobs:
  data-tests:
    name: Data Processing Tests
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: Cache pip dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-data-${{ hashFiles('requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-data-
          ${{ runner.os }}-pip-
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        # Install torch CPU version first
        pip install torch --index-url https://download.pytorch.org/whl/cpu
        # Filter out GPU-specific packages and install the rest
        grep -v "^torch==" requirements.txt | grep -v "^nvidia-" | grep -v "^triton==" | grep -v "^#" | grep -v "^$" > requirements_filtered.txt
        pip install -r requirements_filtered.txt
    
    - name: Run data processing tests
      run: |
        cd pipelines/rl_agent_policy/data/tests
        python main_test.py -v
    
    - name: Generate coverage report
      if: always()
      run: |
        cd pipelines/rl_agent_policy/data/tests
        python main_test.py --coverage
    
    - name: Upload data test results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: data-test-results
        path: |
          htmlcov/
          .coverage
    
  model-tests:
    name: Model Validation Tests
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: Cache pip dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-model-${{ hashFiles('requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-model-
          ${{ runner.os }}-pip-
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        # Install torch CPU version first
        pip install torch --index-url https://download.pytorch.org/whl/cpu
        # Filter out GPU-specific packages and install the rest
        grep -v "^torch==" requirements.txt | grep -v "^nvidia-" | grep -v "^triton==" | grep -v "^#" | grep -v "^$" > requirements_filtered.txt
        pip install -r requirements_filtered.txt
    
    - name: Run model validation tests
      run: |
        cd pipelines/rl_agent_policy/models/tests
        python main_test.py -v
    
    - name: Generate coverage report
      if: always()
      run: |
        cd pipelines/rl_agent_policy/models/tests
        python main_test.py --coverage
    
    - name: Upload model test results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: model-test-results
        path: |
          htmlcov_models/
          .coverage
  
  test-summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [data-tests, model-tests]
    if: always()
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Download all test results
      uses: actions/download-artifact@v4
    
    - name: Display test summary
      run: |
        echo "=========================================="
        echo "Test Execution Summary"
        echo "=========================================="
        echo ""
        echo "✓ Data Processing Tests: Completed"
        echo "✓ Model Validation Tests: Completed"
        echo ""
        echo "Test artifacts uploaded for review."
        echo "=========================================="

